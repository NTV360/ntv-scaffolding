<div
  class="table-container"
  [ngStyle]="tableStyle()"
  tabindex="0"
  role="button"
>
  <!-- Column Settings -->
  @if (showColumnSettings()) {
  <div class="table-header-controls">
    <div class="column-settings">
      <button (click)="columnSettingsPopover.toggle($event)">
        <span [innerHTML]="settingsIcon"></span>
      </button>

      <ntv-popover #columnSettingsPopover placement="bottom-end">
        <div class="w-[250px]">
          <h3 class="mb-4">Show/Hide Columns</h3>

          <input
            type="text"
            class="column-search-input"
            placeholder="Search columns..."
            [value]="columnSearchTerm()"
            (input)="onColumnSearch($event)"
          />

          <div class="column-list">
            @for (column of filteredColumns(); track column.field) {
            <label class="column-option">
              <span>{{ column.header }}</span>

              <div class="toggle-switch">
                <input
                  type="checkbox"
                  class="toggle-input"
                  [checked]="column.visible !== false"
                  (change)="toggleColumnVisibility(column)"
                  [id]="'toggle-' + column.field"
                />
                <span class="toggle-slider"></span>
              </div>
            </label>
            }
          </div>

          <label class="column-option" title="hi">
            <span>Compact View</span>

            <div class="toggle-switch">
              <input
                type="checkbox"
                class="toggle-input"
                (change)="toggleExpandShrinkColumns()"
              />
              <span class="toggle-slider"></span>
            </div>
          </label>

          <div class="column-actions">
            <ntv-button
              variant="danger"
              size="md"
              [fullWidth]="true"
              (click)="resetColumns()"
            >
              Reset
            </ntv-button>
          </div>

          <p class="column-count-info">
            Showing {{ visibleColumnCount() }}/{{ totalColumnCount() }} columns
          </p>
        </div>
      </ntv-popover>
    </div>
  </div>
  }

  <div class="table-wrapper" (scroll)="onTableScroll($event)">
    <table
      [ngStyle]="tableStyle()"
      class="table"
      [class.columns-shrunk]="columnsShrunk()"
    >
      <thead #tableHeader>
        <tr>
          <!-- Checkbox Column Header -->
          @if (hasCheckBox()) {
          <th class="checkbox-column">
            <input
              type="checkbox"
              class="checkbox-input header-checkbox"
              [checked]="selectAll()"
              [indeterminate]="isIndeterminate()"
              (change)="toggleSelectAll()"
              title="Select all rows"
            />
          </th>
          }
          <!-- Index Column Header -->
          @if (hasIndex()) {
          <th class="index-column">#</th>
          }

          <!-- Expandable Column Header -->
          @if (expandableRows()) {
          <th class="expand-column"></th>
          }

          <!-- Expandable Column Draggable -->
          @if (headerTemplate) { @if (columnDraggable()) { @for (column of
          visibleColumns(); track column.field; let i = $index) { @if
          (column.field === 'action') {
          <th
            ntvExpandableColumn
            [expandableColumn]="shouldAutoEnableExpandableColumns()"
            [minWidth]="defaultMinWidth()"
            [maxWidth]="defaultMaxWidth()"
            [style.width]="getColumnWidth(column)"
            [style.min-width]="columnsShrunk() ? null : (column.minWidth || defaultMinWidth() + 'px')"
            [style.max-width]="columnsShrunk() ? null : (column.maxWidth || defaultMaxWidth() + 'px')"
          >
            <!-- Header content for custom header template with draggable columns (with commented filter code) -->
            <div class="header-content">
              <ng-container
                [ngTemplateOutlet]="headerTemplate"
                [ngTemplateOutletContext]="{ $implicit: column }"
              ></ng-container>
            </div>
          </th>
          } @else {
          <th
            ntvDraggableColumn
            ntvExpandableColumn
            [expandableColumn]="shouldAutoEnableExpandableColumns()"
            [minWidth]="defaultMinWidth()"
            [maxWidth]="defaultMaxWidth()"
            [style.width]="getColumnWidth(column)"
            [style.min-width]="columnsShrunk() ? null : (column.minWidth || defaultMinWidth() + 'px')"
            [style.max-width]="columnsShrunk() ? null : (column.maxWidth || defaultMaxWidth() + 'px')"
            [dragData]="column"
            [dragIndex]="i"
            [columnField]="column.field"
            [class.filtered-column]="hasActiveFilter(column.field)"
            (columnReorder)="onColumnReorder($event)"
          >
            <!-- Header content for custom header template with draggable columns !! This is mainly the case when you have custom header templates with draggable columns -->
            <div class="header-content">
              <ng-container
                [ngTemplateOutlet]="headerTemplate"
                [ngTemplateOutletContext]="{ $implicit: column }"
              ></ng-container>
              @if (column.filter && column.field !== 'action' && column.field
              !== 'actions') {
              <div class="column-filter">
                <button (click)="columnFilterPopover.toggle($event)">
                  <span [innerHTML]="filtersIcon"></span>
                </button>

                <ntv-popover #columnFilterPopover placement="bottom-start">
                  <div class="w-[220px]">
                    <ntv-column-filter
                      [column]="column"
                      [data]="filteredData()"
                      [filterValue]="getFilterValue(column.field)"
                      [sortField]="sortField()"
                      [sortOrder]="_sortOrder()"
                      (filterChange)="onFilterChange($event.field, $event.value)"
                      (sortChange)="onSort($event)"
                    ></ntv-column-filter>
                  </div>
                </ntv-popover>
              </div>

              }
            </div>
          </th>
          } } } @else { @for (column of visibleColumns(); track column.field) {
          <th
            ntvExpandableColumn
            [expandableColumn]="shouldAutoEnableExpandableColumns()"
            [minWidth]="defaultMinWidth()"
            [maxWidth]="defaultMaxWidth()"
            [style.width]="getColumnWidth(column)"
            [style.min-width]="columnsShrunk() ? null : (column.minWidth || defaultMinWidth() + 'px')"
            [style.max-width]="columnsShrunk() ? null : (column.maxWidth || defaultMaxWidth() + 'px')"
            [class.filtered-column]="hasActiveFilter(column.field)"
          >
            <!-- Header content for draggable columns with filter functionality (deeply nested case) -->
            <div class="header-content">
              {{ column.header }} @if (column.filter && column.field !==
              'action' && column.field !== 'actions') {
              <div class="column-filter">
                <button (click)="columnFilterPopover2.toggle($event)">
                  <span [innerHTML]="filtersIcon"></span>
                </button>

                <ntv-popover #columnFilterPopover2 placement="bottom-start">
                  <div class="w-[220px]">
                    <ntv-column-filter
                      [column]="column"
                      [data]="filteredData()"
                      [filterValue]="getFilterValue(column.field)"
                      [sortField]="sortField()"
                      [sortOrder]="_sortOrder()"
                      (filterChange)="onFilterChange($event.field, $event.value)"
                      (sortChange)="onSort($event)"
                    ></ntv-column-filter>
                  </div>
                </ntv-popover>
              </div>
              }
            </div>
          </th>
          } } } @else { @if (columnDraggable()) { @for (column of
          visibleColumns(); track column.field; let i = $index) { @if
          (column.field === 'action') {
          <th
            ntvExpandableColumn
            [expandableColumn]="shouldAutoEnableExpandableColumns()"
            [minWidth]="defaultMinWidth()"
            [maxWidth]="defaultMaxWidth()"
            [style.width]="getColumnWidth(column)"
            [style.min-width]="columnsShrunk() ? null : (column.minWidth || defaultMinWidth() + 'px')"
            [style.max-width]="columnsShrunk() ? null : (column.maxWidth || defaultMaxWidth() + 'px')"
            [class.filtered-column]="hasActiveFilter(column.field)"
          >
            <!-- Header content for action columns (no filtering) -->
            <div class="header-content">{{ column.header }}</div>
          </th>
          } @else {
          <th
            ntvDraggableColumn
            ntvExpandableColumn
            [expandableColumn]="shouldAutoEnableExpandableColumns()"
            [minWidth]="defaultMinWidth()"
            [maxWidth]="defaultMaxWidth()"
            [style.width]="getColumnWidth(column)"
            [style.min-width]="columnsShrunk() ? null : (column.minWidth || defaultMinWidth() + 'px')"
            [style.max-width]="columnsShrunk() ? null : (column.maxWidth || defaultMaxWidth() + 'px')"
            [dragData]="column"
            [dragIndex]="i"
            [columnField]="column.field"
            [class.filtered-column]="hasActiveFilter(column.field)"
            (columnReorder)="onColumnReorder($event)"
          >
            <!-- Header content for draggable columns with filter functionality (final case) -->

            <div class="header-content">
              {{ column.header }} @if (column.filter && column.field !==
              'action' && column.field !== 'actions') {
              <div class="column-filter">
                <button (click)="columnFilterPopover3.toggle($event)">
                  <span [innerHTML]="filtersIcon"></span>
                </button>

                <ntv-popover #columnFilterPopover3 placement="bottom-start">
                  <div class="w-[220px]">
                    <ntv-column-filter
                      [column]="column"
                      [data]="filteredData()"
                      [filterValue]="getFilterValue(column.field)"
                      [sortField]="sortField()"
                      [sortOrder]="_sortOrder()"
                      (filterChange)="onFilterChange($event.field, $event.value)"
                      (sortChange)="onSort($event)"
                    ></ntv-column-filter>
                  </div>
                </ntv-popover>
              </div>
              }
            </div>
          </th>
          } } } @else { @for (column of visibleColumns(); track column.field) {
          <th
            ntvExpandableColumn
            [expandableColumn]="shouldAutoEnableExpandableColumns()"
            [minWidth]="defaultMinWidth()"
            [maxWidth]="defaultMaxWidth()"
            [style.width]="getColumnWidth(column)"
            [style.min-width]="columnsShrunk() ? null : (column.minWidth || defaultMinWidth() + 'px')"
            [style.max-width]="columnsShrunk() ? null : (column.maxWidth || defaultMaxWidth() + 'px')"
            [class.filtered-column]="hasActiveFilter(column.field)"
          >
            <!-- Header content for non-draggable columns with date sorting -->
            <div class="header-content">
              {{ column.header }} @if (column.filter && column.filterType ===
              'date') {
              <button
                class="sort-btn"
                (click)="onSort(column.field)"
                title="Sort {{ column.header }}"
              >
                {{ getSortIcon(column.field) }}
              </button>
              }
            </div>
          </th>
          } } }
        </tr>
      </thead>
      <tbody>
        @if (bodyTemplate) { @for (rowData of sortedData(); track rowData; let i
        = $index) {
        <ng-container
          [ngTemplateOutlet]="bodyTemplate"
          [ngTemplateOutletContext]="{
            $implicit: rowData,
            columns: visibleColumns(),
            isLocked: isRowLocked(rowData),
            onLockRow: onLockRow.bind(this),
            onUnlockRow: onUnlockRow.bind(this),
            canLockMoreRows: canLockMoreRows(),
            hasIndex: hasIndex(),
            rowIndex: i + 1,
            stickyTop: isRowLocked(rowData)
              ? getLockedRowStickyTop(rowData)
              : null,
            expandableRows: expandableRows(),
            isExpanded: expandableRows() ? isRowExpanded(rowData) : undefined,
            onToggleExpansion: expandableRows()
              ? toggleRowExpansion.bind(this)
              : undefined,
            expandIcon: expandableRows() ? getExpandIcon(rowData) : undefined,
            hasCheckBox: hasCheckBox(),
            isRowSelected: isRowSelected.bind(this),
            onToggleRowSelection: toggleRowSelection.bind(this)
          }"
        ></ng-container>
        <!-- Expandable Content Row for Custom Template -->
        @if (expandableRows() && isRowExpanded(rowData) &&
        expandedContentTemplate) {
        <tr class="expanded-content-row">
          <td
            [attr.colspan]="getExpandedContentColspan()"
            class="expanded-content-cell"
          >
            <div class="expanded-content-wrapper">
              <ng-container
                [ngTemplateOutlet]="expandedContentTemplate"
                [ngTemplateOutletContext]="{
                  $implicit: rowData,
                  rowData: rowData,
                  columns: visibleColumns(),
                  isExpanded: true
                }"
              ></ng-container>
            </div>
          </td>
        </tr>
        } } } @else { @for (rowData of sortedData(); track rowData; let i =
        $index) {
        <tr
          [class.locked-row]="isRowLocked(rowData)"
          [style.--sticky-top]="
            isRowLocked(rowData) ? getLockedRowStickyTop(rowData) : null
          "
        >
          <!-- Checkbox Column Data -->
          @if (hasCheckBox()) {
          <td class="checkbox-column">
            <input
              type="checkbox"
              class="checkbox-input row-checkbox"
              [checked]="isRowSelected(rowData)"
              (change)="toggleRowSelection(rowData)"
              [title]="isRowSelected(rowData) ? 'Deselect row' : 'Select row'"
            />
          </td>
          }
          <!-- Index Column Data -->
          @if (hasIndex()) {
          <td class="index-column">{{ i + 1 }}</td>
          }
          <!-- Expandable Column Data -->
          @if (expandableRows()) {
          <td class="expand-column">
            <button
              class="expand-btn"
              (click)="toggleRowExpansion(rowData)"
              [title]="isRowExpanded(rowData) ? 'Collapse row' : 'Expand row'"
              [innerHTML]="getExpandIcon(rowData)"
            ></button>
          </td>
          } @for (col of visibleColumns(); track col.field) {
          <td
            [class.filtered-column-cell]="hasActiveFilter(col.field)"
            [style.width]="getColumnWidth(col)"
            [style.min-width]="col.minWidth || defaultMinWidth() + 'px'"
            [style.max-width]="col.maxWidth || defaultMaxWidth() + 'px'"
          >
            @if (col.field === 'status') {
            <span [class]="'status-' + rowData[col.field]?.toLowerCase()">
              {{ rowData[col.field] }}
            </span>
            } @else if (col.field === 'actions') {
            <div class="action-buttons">
              @if (isRowLocked(rowData)) {
              <button
                class="unlock-btn"
                (click)="onUnlockRow(rowData)"
                title="Unlock Row"
              >
                🔓
              </button>
              } @else { @if (canLockMoreRows()) {
              <button
                class="lock-btn"
                (click)="onLockRow(rowData)"
                title="Lock Row"
              >
                🔒
              </button>
              } }
            </div>
            } @else { {{ rowData[col.field] }} }
          </td>
          }
        </tr>
        <!-- Expandable Content Row -->
        @if (expandableRows() && isRowExpanded(rowData) &&
        expandedContentTemplate) {
        <tr class="expanded-content-row">
          <td
            [attr.colspan]="getExpandedContentColspan()"
            class="expanded-content-cell"
          >
            <div class="expanded-content-wrapper">
              <ng-container
                [ngTemplateOutlet]="expandedContentTemplate"
                [ngTemplateOutletContext]="{
                  $implicit: rowData,
                  rowData: rowData,
                  columns: visibleColumns(),
                  isExpanded: true
                }"
              ></ng-container>
            </div>
          </td>
        </tr>
        } } }
      </tbody>
      @if (sortedData().length === 0) {
      <tbody>
        <tr>
          <td [attr.colspan]="getTotalColumnCount()" class="no-data-cell">
            <div class="no-data-row">
              <div class="no-data-content">
                <div class="no-data-icon">
                  <iframe
                    src="https://lottie.host/embed/06452cb8-66f8-47d8-8c70-277079486b86/BSviPOAH23.lottie"
                    width="400"
                    height="400"
                  ></iframe>
                </div>
                <div class="no-data-message">No Data Found</div>
                <div class="no-data-description">
                  Whoopss... There are no records to display at the moment
                </div>
              </div>
            </div>
          </td>
        </tr>
      </tbody>
      }
    </table>
  </div>

  <!-- Pagination: Show More  -->
  <div class="pagination">
    <p class="pagination-text">
      Showing <span class="font-bold">{{ currentlyShowing() }}</span> of
      <span class="font-bold">{{ totalItems() }}</span>
    </p>

    @if (hasMoreItems()) {
    <button (click)="showMore()" class="pagination-text">Show More</button>
    }
  </div>

  <!-- Loading Overlay -->
  @if (isProcessing()) {
  <div class="table__loading-overlay">
    <div class="table__loading-content">
      <div class="table__loading-spinner"></div>
      <div class="table__loading-message">{{ loadingMessage() }}</div>
    </div>
  </div>
  }
</div>
